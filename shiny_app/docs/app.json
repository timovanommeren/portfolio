[{"name":"app.R","content":"\r\nlibrary(shiny)\r\nlibrary(bslib)\r\nlibrary(ggplot2)\r\nlibrary(scales)\r\nlibrary(shinyjs)\r\nlibrary(shinylive)\r\nlibrary(httpuv)\r\n\r\n# Define UI for application that draws a histogram\r\nui <- page_navbar(\r\n  title = \"Estimating MDMA Monopoly Revenues\",\r\n  theme = bs_theme(version = 5),\r\n  useShinyjs(),\r\n  \r\n  nav_panel(\r\n    \"About\",\r\n    card(\r\n      card_header(\"Background & Formula\"),\r\n      tags$p(\r\n        tags$strong(\"This shiny app compliments the report: Counting the Returns MDMA quickscan, by the municipality of Amsterdam\"),\r\n        \"The quickscan provides an estimate of the potential revenue that could be generated by a state-run MDMA monopoly in the Netherlands. As there is no precedent for a regulated MDMA market, our analysis is partly based on educated guesses. For instance, we have made assumptions regarding the production costs of MDMA and the proportion of consumers who would switch to a regulated market. This app enables you to easily calculate your own revenue estimates for a state-run MDMA monopoly, based on various assumptions. For more elaborate definitions, please consult the accompanying report.\",\r\n        tags$br(),\r\n        tags$p(\r\n          style = \"margin-top: 1rem;\",\r\n          \"Revenue is calculated using the following formula: \",\r\n          tags$span(\r\n            style = \"white-space: nowrap;\",\r\n            tags$em(\"Number of consumers\"), \" × \",\r\n            tags$em(\"Frequency\"), \" × \",\r\n            tags$em(\"Intensity\"), \" × \",\r\n            tags$em(\"Market capture\"), \" × (\",\r\n            tags$em(\"Price\"), \" − \", tags$em(\"Cost\"), \").\"\r\n          )\r\n        )\r\n      )\r\n    )\r\n  ),\r\n  \r\n  # ---- PAGE 1: Assumptions ----\r\n  nav_panel(\r\n    \"Analysis\",\r\n    layout_sidebar(\r\n      \r\n      sidebar = sidebar(\r\n        title = \"Estimates\",\r\n        open = TRUE,            # keep sidebar open by default\r\n        width = 360,            # tweak to taste\r\n        \r\n        # subtitle under the title\r\n        div(class = \"small text-muted mb-3\",\r\n            \"There is an open field and a slider for each variable below. Enter your best guess in the open fields to produce the number below. The sliders allow you to set a range and generate multiple simulated outcomes. These are shown in the figure on the right.\"\r\n        ),\r\n        # add space around subtitle\r\n        tags$hr(class = \"my-2\"),\r\n        \r\n        accordion(\r\n          id = \"assumption_panels\", \r\n          multiple = FALSE,      # only one panel open at a time\r\n          open = c(\"Simulation settings\"),  # default open panels\r\n        \r\n          # --- Number of consumers ---\r\n          accordion_panel(\r\n            \"Number of consumers\",\r\n            p(class = \"text-muted small\", \"Estimated number of annual MDMA consumers in the Netherlands.\"),\r\n            numericInput(\"num_consumers\", \"Number of consumers\", value = 550000, min = 0, step = 1000),\r\n            sliderInput(\"num_consumers_range\", \"Range\", min = 0, max = 18000000, value = c(300000, 800000), step = 1000)\r\n          ),\r\n          \r\n          # --- Frequency ---\r\n          accordion_panel(\r\n            \"Frequency\",\r\n            h6(class = \"text-muted\", \"Annual sessions per consumer.\"),\r\n            checkboxInput(\"use_empirical\", \"Use empirical data from Party Panel\", value = TRUE),\r\n            \r\n            # Manual inputs (visible always; disabled when 'use_empirical' is TRUE)\r\n            numericInput(\r\n              \"freq_point\", \"Point estimate (sessions/year)\",\r\n              value =  round(4.7, 1), min = 0, step = 0.5\r\n            ),\r\n            sliderInput(\r\n              \"freq_range\", \"Range (sessions/year)\",\r\n              min = 0, max = 100, value = c(1, 30), step = 1\r\n            ),\r\n            helpText(\"When empirical data is selected, the manual controls are shown but disabled.\")\r\n          ),\r\n          \r\n          # --- Intensity ---\r\n          accordion_panel(\r\n          \"Intensity\",\r\n          p(class = \"text-muted small\", \"Average number of pills per session.\"),\r\n          numericInput(\"intensity_point\", \"Pills per session\", value = 2, min = 0, step = 0.1),\r\n          sliderInput(\"intensity_range\",   \"Range\", min = 0, max = 10, value = c(1, 3), step = 0.01),\r\n          ),\r\n          \r\n          #--- Market capture ---\r\n          accordion_panel(\r\n          \"Market capture\",\r\n          p(class = \"text-muted small\", \"Proportion of consumers who switch to the regulated market.\"),\r\n          numericInput(\"mkr_point\", \"Point estimate\", value = 0.8, min = 0, max = 1, step = 0.01),\r\n          sliderInput(\"mkr_range\", \"Range\", min = 0, max = 1, value = c(0.4, 0.9), step = 0.01),\r\n          ),\r\n          \r\n          # --- Price & Cost ---\r\n          accordion_panel(\r\n          \"Price & Cost (€/pill)\",\r\n          p(class = \"text-muted small\", \"Cost is total marginal cost per pill.\"),\r\n          numericInput(\"price_point\", \"Price point estimate\", value = 5, min = 0, step = 0.1),\r\n          sliderInput(\"price_range\", \"Price range\", min = 0, max = 20, value = c(3, 8), step = 0.1),\r\n          numericInput(\"cost_point\", \"Cost point estimate\", value = 2, min = 0, step = 0.1),\r\n          sliderInput(\"cost_range\", \"Cost range\", min = 0, max = 20, value = c(1, 8), step = 0.1)\r\n          ),\r\n          \r\n          #--- Simulation settings ---\r\n          accordion_panel(\r\n            \"Simulation settings\",\r\n            h6(class = \"text-muted\", \"Control Monte Carlo sampling.\"),\r\n            numericInput(\r\n              \"sim_n\", \"Number of draws (n)\",\r\n              value = 10000, min = 100, max = 1e6, step = 1000\r\n            ),\r\n            numericInput(\r\n              \"sim_seed\", \"Random seed\",\r\n              value = 1234, min = 0, step = 1\r\n            ),\r\n            helpText(\"Larger n gives smoother plots but takes longer to compute.\")\r\n          )\r\n        ),\r\n      \r\n      \r\n      # ---- Main content (outputs) ----\r\n      card(\r\n        card_header(\"Expected revenue\"),\r\n        h1(textOutput(\"point_estimate\", container = h2), class = \"display-5\")\r\n      )\r\n    ),\r\n      \r\n      # ---- Simulation results ----\r\n      card(\r\n        card_header(\"Variation in expected revenue\"),\r\n        plotOutput(\"revenue_plot\", height = \"420px\")\r\n      )\r\n    )\r\n  ),\r\n  \r\n  # ---- PAGE 2 (blank for now) under a menu ----\r\n  nav_menu(\r\n    \"More\",\r\n    nav_panel(\r\n      \"Frequency (coming soon)\",\r\n      fluidPage(\r\n        h4(\"Frequency\"),\r\n        p(\"This page will host frequency inputs, data loading, and related outputs.\")\r\n      )\r\n    )\r\n  )\r\n)\r\n\r\nserver <- function(input, output, session) {\r\n  \r\n  # Enable/disable frequency inputs based on empirical checkbox\r\n  observe({\r\n    if (isTRUE(input$use_empirical)) {\r\n      shinyjs::disable(\"freq_point\")\r\n      shinyjs::disable(\"freq_range\")\r\n    } else {\r\n      shinyjs::enable(\"freq_point\")\r\n      shinyjs::enable(\"freq_range\")\r\n    }\r\n  })\r\n  \r\n  # Import empirical frequency \r\n  party_panel <- read.csv(\"Party_Panel.csv\", check.names = FALSE)\r\n  \r\n  # drop the last five rows (your comment says five, not one)\r\n  if (nrow(party_panel) >= 5) {\r\n    party_panel <- party_panel[seq_len(nrow(party_panel) - 5), ]\r\n  }\r\n  \r\n  party_panel[] <- lapply(party_panel, function(x) as.numeric(x))\r\n  \r\n  frequency_mean <- with(party_panel, sum(Gebruik * Frequencies, na.rm = TRUE) / sum(Frequencies, na.rm = TRUE))\r\n  \r\n  # Point estimate uses point inputs only\r\n  revenue_point <- reactive({\r\n    mkr  <- input$mkr_point\r\n    p    <- input$price_point\r\n    cst  <- input$cost_point\r\n    inten <- input$intensity_point\r\n    number_consumers <- input$num_consumers\r\n    \r\n    # choose frequency source\r\n    freq <- if (isTRUE(input$use_empirical)) frequency_mean else input$freq_point\r\n    \r\n    number_consumers * freq * inten * mkr * (p - cst)\r\n  })\r\n  \r\n  output$point_estimate <- renderText({\r\n    val <- revenue_point()\r\n    paste0(\"€ \", format(round(val, 0), big.mark = \",\"))\r\n  })\r\n  \r\n  # ---- Monte Carlo simulation (reactive) ----\r\n  sim_draws <- reactive({\r\n    \r\n    n    <- input$sim_n\r\n    seed <- input$sim_seed\r\n    number_consumers <- input$num_consumers\r\n    \r\n    \r\n    set.seed(seed)  # we can make this user-set later\r\n    \r\n    # Inputs \r\n    inten_lower <- input$intensity_range[1]\r\n    inten_upper   <- input$intensity_range[2]\r\n    \r\n    mkr_lower  <- input$mkr_range[1]\r\n    mkr_upper  <- input$mkr_range[2]\r\n    \r\n    price_lower <- max(0, input$price_range[1])\r\n    price_upper <- max(price_lower, input$price_range[2])  \r\n    \r\n    cost_lower  <- max(0, input$cost_range[1])\r\n    cost_upper  <- max(cost_lower, input$cost_range[2])\r\n    \r\n    # Draws (vectorized)\r\n    intensity <- runif(n, min = inten_lower, max = inten_upper)\r\n    market    <- runif(n, min = mkr_lower,   max = mkr_upper)\r\n    price     <- runif(n, min = price_lower, max = price_upper)\r\n    cost      <- runif(n, min = cost_lower,  max = cost_upper)\r\n    \r\n    if (isTRUE(input$use_empirical)) {\r\n      # empirical sampling (first 21 rows)\r\n      freq <- sample(\r\n        x       = party_panel$Gebruik[1:21],\r\n        size    = n, replace = TRUE,\r\n        prob    = party_panel$Frequencies[1:21]\r\n      )\r\n    } else {\r\n      # manual uniform range\r\n      fmin <- max(0, input$freq_range[1])\r\n      fmax <- max(fmin, input$freq_range[2])\r\n      freq <- runif(n, min = fmin, max = fmax)\r\n    }\r\n    \r\n    revenue <- number_consumers * freq * intensity * market * (price - cost)\r\n    revenue\r\n  })\r\n  \r\n  # # ---- Point estimate ----\r\n  # revenue_estimate_freq <- reactive({\r\n  #   number_consumers * frequency_mean *\r\n  #     max(0, input$intensity_point) *\r\n  #     max(0, min(1, input$mkr_point)) *\r\n  #     (max(0, input$price_point) - max(0, input$cost_point))\r\n  # })\r\n  \r\n  # ---- Histogram render ----\r\n  output$revenue_plot <- renderPlot({\r\n    library(ggplot2)\r\n    library(scales)\r\n    \r\n    revenue <- sim_draws()\r\n    rev_est <- revenue_point()\r\n    \r\n    # Quantiles + point estimate\r\n    qs <- quantile(revenue, c(0.05, 0.5, 0.95), na.rm = TRUE)\r\n    ref_lines <- data.frame(\r\n      type  = c(\"5th percentile\", \"Median\", \"95th percentile\", \"Point estimate\"),\r\n      value = c(qs[1], qs[2], qs[3], rev_est)\r\n    )\r\n    \r\n    # Build a base histogram first to learn the y scale\r\n    bins <- 60\r\n    p0 <- ggplot(data.frame(revenue = revenue), aes(x = revenue)) +\r\n      geom_histogram(bins = bins, alpha = 0.85)\r\n    \r\n    gb <- ggplot_build(p0)\r\n    ymax <- max(gb$data[[1]]$count, na.rm = TRUE)   # histogram's tallest bar\r\n    seg_frac <- 0.1                                # how tall the markers should be (0–1)\r\n    below_frac <- 0.04\r\n    ref_lines$ymin <- -ymax * below_frac\r\n    ref_lines$ymax <- ymax * seg_frac\r\n    \r\n    # Re-draw with capped vertical markers\r\n    ggplot(data.frame(revenue = revenue), aes(x = revenue)) +\r\n      geom_histogram(bins = bins, alpha = 0.85) +\r\n      geom_linerange(\r\n        data = ref_lines,\r\n        aes(x = value, ymin = ymin, ymax = ymax, color = type),\r\n        linewidth = 1\r\n      ) +\r\n      scale_color_manual(\r\n        values = c(\r\n          \"Point estimate\"   = \"blue\",\r\n          \"Median\"           = \"black\",\r\n          \"5th percentile\"   = \"grey50\",\r\n          \"95th percentile\"  = \"grey50\"\r\n        ),\r\n        name = NULL\r\n      ) +\r\n      labs(\r\n        title = \"Projected Annual Revenue of a State MDMA Monopoly\",\r\n        x = \"Revenue\", y = \"Count\"\r\n      ) +\r\n      scale_x_continuous(labels = label_number(prefix = \"€\", big.mark = \",\")) +\r\n      theme_minimal(base_size = 13) +\r\n      theme(\r\n        plot.background = element_rect(fill = \"white\", color = NA),\r\n        legend.position = \"bottom\"\r\n      )\r\n  })\r\n  \r\n  \r\n  \r\n  \r\n}\r\n\r\n# Run the application \r\nshinyApp(ui = ui, server = server)\r\n","type":"text"},{"name":"Party_Panel.csv","content":"Gebruik,Frequencies,Perc.Total,Perc.Valid,Cumulative\r\n1,305,22.4,22.4,22.4\r\n2,294,21.6,21.6,44\r\n3,196,14.4,14.4,58.4\r\n4,106,7.8,7.8,66.2\r\n5,53,3.9,3.9,70.1\r\n6,198,14.5,14.5,84.6\r\n7,17,1.2,1.2,85.9\r\n8,21,1.5,1.5,87.4\r\n9,9,0.7,0.7,88.1\r\n10,9,0.7,0.7,88.8\r\n11,1,0.1,0.1,88.8\r\n12,87,6.4,6.4,95.2\r\n14,2,0.1,0.1,95.4\r\n15,8,0.6,0.6,96\r\n16,1,0.1,0.1,96\r\n17,1,0.1,0.1,96.1\r\n18,26,1.9,1.9,98\r\n20,5,0.4,0.4,98.4\r\n24,4,0.3,0.3,98.7\r\n25,1,0.1,0.1,98.8\r\n26,11,0.8,0.8,99.6\r\n30,1,0.1,0.1,99.6\r\n36,1,0.1,0.1,99.7\r\n52,2,0.1,0.1,99.9\r\n60,1,0.1,0.1,99.9\r\n78,1,0.1,0.1,100\r\n,Total valid,1361,100,100","type":"text"}]
